## 4.网络层

网络层实现主机到主机的通信服务。

网络层的功能：**转发** 和 **路由选择**

数据平面--转发是指将分组从一个输入链路接口转移到适当的输出链路接口的**路由本地动作**。

控制平面--路由选择是指确定分组从源到目的地所采取的端到端路径的**网络范围处理过程**。控制平面还控制网络层组件和服务如何配置和管理。

每个路由器都有它的转发表。由路由选择算法决定转发表中的值。路由器的转发表一开始的配置方法：传统的方法是由人工直接配置,但容易出错；SDN方法，远程控制器计算和分发转发表以供每台路由器所使用。


### 4.1网络服务模型

**尽力而为服务** ：传送的分组既不保证它们以发送的顺序被接收，也不能保证它们最终交付；

既不能保证端到端的服务，也不能保证有最小带宽。

**分组交换机** 

1.链路层交换机：基于链路层帧中的字段值做出转发决定。

2.路由器：基于网络层数据报中的首部字段值做出转发决定。



### 4.2路由器工作原理

路由器4个部件：

输入端口--在输入端口执行查找功能。

交换结构

输出端口

路由选择处理器--执行控制平面的功能和网络管理功能。



路由器用分组目的地址的**前缀**与该表中的表项进行匹配。当有对各匹配时，使用 **最长前缀匹配规则** 



交换技术： 经内存交换、经总线交换、经互联网络交换。



### 4.3网际协议：IPv4、寻址

网络层分组称为 **数据报** 。

IPv4数据报格式

数据报长度--16比特，最大长度为65535字节，但数据报很少超过1500字节，受到以太网帧长度的限制。

标识、标志、片偏移--与IP分片有关。

协议--指示了IP数据报的数据部分应交给哪个特定的运输层协议。

首部校验和--用于帮助路由器检测收到的IP数据包中的比特错误。



一个链路层真能承载的最大数据量叫做 **最大传送单元（MTU）** ,故链路层协议的MTU严格地限制着IP数据报的长度。

IPv6中数据报的重新组装工作在 **端系统** 中，而不是在网络路由器中。

一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。

局域网内的接口使用以太网交换机互联，各个网络间使用路由器互联。

点分十进制数形式 a.b.c.d/x，其中x指示了地址的第一部分中的比特数，剩余32-x比特可认为是用于区分该组织内部设备的。



主机或子网最初如何得到它们的地址？

1.**获取一块地址**

IP地址由因特网名字和编号分配机构管理。

2.**获取主机地址：动态主机配置协议 DHCP**

DHCP允许主机自动获取一个IP地址





**网络地址转换 NAT**

本质上，NAT使能路由器对外界隐藏了家庭网络的细节。

路由器如何知道它应将某个分组转发给哪个内部主机？使用NAT路由器上的一张NAT转换表，并且在表项中包含了端口号极其IP地址。

NAT称为因特网的一个重要组件（中间盒），中间盒并不执行传统的数据报转发，而是执行诸如NAT、流量流的负载均衡、流量防火墙等功能。

 

### 4.4路由选择算法

集中式路由选择算法：链路状态LS算法

分散式路由选择算法：距离向量DV算法 （增加毒性转发）

还可分为静态/动态路由选择算法。



### 4.5因特网中自治系统内部的路由选择：OSPF

通常在一个ISP中的路由器以及互联它们的链路构成一个 **自治系统 AS**

一个自治系统由其全局唯一的AS号所标识。



**开放最短路优先 OSPF**



### 4.6 ISP之间的路由选择： BGP

在因特网中，所有的AS运行相同的AS间路由选择协议，**边界网关协议BGP.**

BGP为每台路由器提供了一种完成以下任务的手段：

1.从邻居AS获得前缀的可达性信息。BGP允许每个子网想因特网的其余部分通告它的存在。

2.确定到该前缀的“最好的”路由。 该最好的路由将基于策略以及可达性信息来确定。



跨越两个AS的BGP连接称为 **外部BGP连接 （eBGP）**

在相同AS中的两台路由器之间的BGP会话称为 **内部BGP连接（iBGP）**



**确定最好的路由： 热土豆路由选择**

使用热土豆路由选择，从所有可能的路由中选择的路由到开始改路由的NEXT-HOP路由器具有最小开销。



### 4.7 ICMP:因特网控制报文协议

ICMP被主机和路由器用来彼此沟通网络层的信息。ICMP最经典用途是差错报告。

ping层序发送一个ICMP类型8编码0的报文到指定主机。看到回显请求，目的主机发送一个类型0编码0的ICMP回显回答。







