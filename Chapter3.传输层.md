## 3.运输层

### 3.1运输层服务

运输层两大重要协议TCP / UDP .

运输层协议是在端系统中而不是在路由器中实现的。在发送端，运输层将从发送应用程序进程接收到的报文转换成运输层分组（**报文段**）。 运输层将报文段传递给网络层。

UDP和TCP最基本的责任是将网络层的两个端系统（主机）间IP的交付服务扩展为运行在端系统上的两个进程之间的交付服务。将主机交付扩展到进程间交付被称为 **运输层的多路复用** 与 **多路分解**。

### 3.2多路复用与多路分解

在接收端，运输层检查报文段中的字段，标识出接收套接字，进而将报文段定向到该套接字。将运输层报文段中的数据交付到正确的套接字的工作称 **多路分解**。

在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息（这将用于分解）从而生成报文段，然后将报文段传递到网络层，这称 **多路复用**。

多路复用要求：1.套接字有唯一标识符；2.每个报文段有特殊字段（**源/目的端口字段**）来指示该报文段所要交付到的套接字。

### 



### 3.3无连接运输：UDP

#### 3.3.1 UDP报文段结构

![](F:\Desktop\Typora\Computer-Network\UDP报文段格式.png)

通过目的端口号可以使目的主机将应用数据交给运行在目的端系统中的相应进程（即执行分解功能），

长度：在UDP报文段中的字节数（首部加数据）

接收方使用检验和检查在该报文段中是否出现了差错。

#### 3.3.2 UDP 校验和

提供差错校验功能，校验和用于确定当UDP报文段从源到达目的地移动时，其中的比特是否发生了改变。虽然它提供差错检测，但它对差错恢复无能为力。

### 3.4可靠数据传输原理

#### 3.4.1 构造可靠数据传输协议

**1.经完全可靠信道的可靠数据传输：rdt 1.0**  [rdt可靠数据传输协议]

rdt 1.0 发送方和接收方的有限状态机（FSM）：

![](F:\Desktop\Typora\Computer-Network\用于完全可靠信道的协议.png)

发送方和接收方有各自的FSM，且FSM每个都只有一个状态。图中的箭头指示了协议从一个状态变迁到另一个状态，引起变迁的事件显示在表示变迁的横线上方，事件发生时所采取的动作显示在横线下方。FSM的初始状态用虚线表示。

**2.经过有比特差错信道的可靠数据传输： rdt 2.0**

自动重传请求（ARQ）协议中还需要另外三种协议功能来处理存在比特差错的情况：

差错检测，一种机制以使接收方检测到何时出现了比特差错。

接收方反馈，发送方要了解接收方情况（此时分组是否被正确接收）的唯一途径就是让接收方提供明确的反馈信息给发送方。

重传，接收方收到有差错的分组时，发送方重传该分组文。

![](F:\Desktop\Typora\Computer-Network\用于具有比特差错信道的协议.png)

rdt 2.0 的FSM，ACK:肯定确认， NAK：否定确认  sndpkt：包含待发送数据的分组

停等协议：当发送方处于等待ACK或NAK的状态时，它不能从上层获得更多的数据 （rdt_send（）事件不可能出现），仅当接收到ACK并离开该状态时才能发生这样的事件。

rdt 2.0 缺陷：没有考虑到ACK或NAK分组受损的可能性

处理：当发送方收到含糊不清的ACK或NAK分组时，只需重传当前数据分组即可。但会引入 **冗余分组**， 冗余分组的困难在于接收方不知道它上次发送的ACK或NAK是否被发送方正确地接收到，所以它没法知道接收到的分组是新的还是一次重传。

解决上面问题方法：在数据分组中添加一个序号字段。

rdt 2.0修订版发送方和接收方FSM的状态数都是以前的两倍，因为协议状态要反映出目前（由发送方）正发送的分组或（在接收方）希望接收的分组的序号是0还是1.

rdt2.1 发送方：

![](F:\Desktop\Typora\Computer-Network\rdt2.1 发送方.png)



rdt2.1 接收方：

![](F:\Desktop\Typora\Computer-Network\rdt2.1 接收方.png)



rdt2.2 在接收方必须包括由一个ACK报文所确认的分组序号（通过在接收方FSM中，在make_pkt()中包括参数ACK0或ACK1来实现），发送方必须检查接收到的ACK报文中被确认的分组序号（通过在发送方FSM中，在isACK()中包括参数0或1来实现）。

![](F:\Desktop\Typora\Computer-Network\rdt2.2 发送方.png)

![](F:\Desktop\Typora\Computer-Network\rdt2.2 接收方.png)



**3.经具有比特差错的丢包信道的可靠数据传输：rdt3.0**

为了实现基于时间的重传机制，实现了一个 **倒计数定时器** ，在一个给定的时间量过期后，可中断发送方。

rdt3.0问题：它是一个停等协议。

数据传输协议要点：检验和、序号、定时器、肯定和否定确认分组。

#### 3.4.2流水线可靠数据传输协议

不使用停等方式，允许发送方发送多个分组而无需等待确认。

解决流水线的差错恢复方法： **回退N步** 和 **选择重传**

#### 3.4.3 回退N步

滑动窗口协议（GBN）

![](F:\Desktop\Typora\Computer-Network\GBN.png)

#### 3.4.4 选择重传

选择重传协议通过让发送方仅重传那些它怀疑在接收方出错（即丢失或受损）的分组而避免了不必要的重传。



### 3.5 面向连接的运输：TCP

#### 3.5.1 TCP连接

TCP协议只在端系统中运行，而不在中间的网络元素（路由器和链路层交换机）中运行，所以中间的网络元素不会维持TCP连接状态。中间路由器看到的是数据报，而不是连接。

TCP连接提供的是 **全双工服务** ，也总是 **点对点** 的，即在单个发送方和单个接收方之间的连接。

#### 3.5.2 TCP报文段结构

![](F:\Desktop\Typora\Computer-Network\TCP报文段结构.png)

TCP把数据看成一个无结构的、有序的字节流，序号是建立在传送的字节流之上，而不是在传送的报文段的序列之上。一个报文段的序号是该报文段首字节的字节流编号。

#### 3.5.5 流量控制

让发送方维护一个 **接收窗口** 的变量来提供流量控制。接收窗口用于给发送方一个指示：该接收方还有多少可用的缓存空间。

#### 3.5.6 TCP连接管理

![](F:\Desktop\Typora\Computer-Network\TCP三次握手.png)



![](F:\Desktop\Typora\Computer-Network\TCP四次挥手.png)

### 3.6拥塞控制原理

#### 3.6.1 拥塞原因与代价

1.分组的到达速率接近链路容量时，分组经历巨大的排队时延。

2.发送方必须执行重传以补偿因为缓存溢出而丢失的分组。

3.当一个分组沿一条路径被丢弃时，每个上游路由器用于转发该分组到丢弃该分组而使用的传输容量被浪费了。



#### 3.6.2 拥塞控制方法

端到端拥塞控制。网络层没有为运输层拥塞控制提供显示支持

网络辅助的拥塞控制。网络层构件（即路由器）向发送方提供关于网络中的拥塞情况



### 3.7 TCP拥塞控制

**1.慢启动**

**2.拥塞避免**

**3.快速恢复**

























